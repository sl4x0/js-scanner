function each(e,t){let n=0;for(const o in e)e.hasOwnProperty(o)&&t(e[o],o,n++)}function ime(){const e=Object.create({sendEnabled:function(e){window.native.call("Ime"+(e.enabled?"Enable":"Disable"))},sendRect:function(e){const t=window.native.scale||1,n=t*e.width,o=t*e.height;window.native.call("ImeSetRectDim",{left:e.left?parseInt(e.left,10):0,top:e.top?parseInt(e.top,10):0,width:n||0,height:o||0})},sendSelection:function(e){const t="backward"===e.direction,n=t?e.end:e.start,o=t?e.start:e.end;window.native.call("ImeSetSelection",n,o)},sendText:function(e){window.native.call("ImeSetText",e.text)},schema:{enabled:{type:"bool",value:!1},text:{type:"string",value:""},start:{type:"int",value:0},end:{type:"int",value:0},direction:{type:"string",value:"forward"},width:{type:"int",value:0},height:{type:"int",value:0},top:{type:"int",value:0},left:{type:"int",value:0}},groups:{Enabled:["enabled"],Text:["text"],Selection:["start","end","direction"],Rect:["width","height","top","left"]},group:function(t){let n;return each(e.groups,(function(e,o){e.indexOf(t)>=0&&(n=o)})),n},stage:function(t){const n=Object.keys(e).every((function(t){return!1===e[t]}));e.groups[t].staged||(e.groups[t].staged=!0),n&&setTimeout(e.commit,0)},commit:function(){each(e.groups,(function(t,n){if(!t.staged)return;const o={},i=e[`send${n}`];t.forEach((function(t){o[t]=e[t]})),i(o),t.staged=!1}))}});each(e.schema,(function(t,n){t.group=e.group(n),Object.defineProperty(e,n,{get:function(){return t.value},set:function(n){return n=function(e,t){switch(t){case"int":return parseInt(e,10);case"bool":return Boolean(e)}return e instanceof Object&&(e=JSON.stringify(e)),`${e}`}(n,t.type),t.value===n?n:(e.stage(t.group),t.value=n)}})})),window.native.on("ImeTextStore",(function(e){document.activeElement&&(document.activeElement.value=e.text,document.activeElement.dispatchEvent(new Event("input",{bubbles:!0}))),window.postMessage(["ime:native",{direction:e.caret===e.selStart?"backward":"forward",text:e.text,start:e.selStart,end:e.selEnd}],"*")})),window.addEventListener("message",(function(e){if(e.source!==window)return;const t=e.data,n=t&&t.length&&"ime:client"===t[0]&&t[0]&&t[1];GW2.Ime=n}),!0),Object.defineProperty(GW2,"Ime",{get:function(){return e},set:function(t){t&&each(t,(function(t,n){e[n]=t}))}})}const doc$1=window.document.documentElement;function scale(){const e=Math.min(window.innerWidth/doc$1.offsetWidth,window.innerHeight/doc$1.offsetHeight);window.native.scale=e,doc$1.style["transform-origin"]="top left",doc$1.style.transform=`scale(${e})`}const doc=window.document.documentElement;function setOrExpireCookie(e,t,n){document.cookie=e?`${t}=${n};`:`${t}= ; expires = Thu, 01 Jan 1970 00:00:00 GMT;`}function initSession(e){const t=new URLSearchParams(window.location.search),n=t.get("profile"),o=null!==t.get("record")&&!e,i=Math.random().toString(36).slice(2);e&&(window.native={}),setOrExpireCookie(e||o,"mockSessionId",i),setOrExpireCookie(n,"mockProfileId",n),window.native.record=o,scale(),window.self===window.top&&window.addEventListener("resize",scale,!1)}async function initNative(e,t,{onStats:n}={}){return window.native.player=e.player=await e.import("gw2/player"),window.native.stats=e.stats=await e.call("GetStats"),window.native.buildInfo=e.buildInfo=await e.call("GetBuildInfo"),"GW2"in window||(window.GW2={}),e.on("stats",(e=>{Object.assign(window.native.stats,e),doc.lang!==window.native.stats.language&&(window.location=window.location.href.replace(`language=${doc.lang}`,`language${e.language}`)),"vip"in e&&location.reload(),n&&n(e)})),"zh"===window.native.stats.language&&ime(),document.documentElement.setAttribute("data-mock",t),{player:window.native.player,stats:window.native.stats,buildInfo:window.native.buildInfo}}const DELAY_IN_MS=50,allSubscriptions={};function getSubscriptions({type:e,event:t}){return allSubscriptions[e]||(allSubscriptions[e]={}),allSubscriptions[e][t]||(allSubscriptions[e][t]=[]),allSubscriptions[e][t]}function handleEvents(e){setTimeout((()=>{e.forEach((({type:e,event:t,data:n,result:o})=>{o&&getSubscriptions({type:e,event:t,data:n}).forEach((e=>e(o)))}))}),50)}function subscribeEvent({type:e,event:t,cb:n}){getSubscriptions({type:e,event:t}).push(n)}function queryString(e){return Object.entries(e).filter((([e,t])=>t)).map((([e,t])=>`${e}=${"string"==typeof t?t:JSON.stringify(t)}`)).join("&")}function write({type:e,event:t,data:n,result:o}){return fetch("/native/mock-data",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({type:e,event:t,data:n,result:o})}).catch((e=>{console.log({err:e})}))}function read({type:e,event:t,data:n}){return fetch(`/native/mock-data?${queryString({type:e,event:t,data:n})}`).then((async e=>{const t=await e.json();if(200!==e.status)throw t;return t})).then((e=>(e.emittedEvents&&handleEvents(e.emittedEvents),e.result))).catch((e=>{throw console.log({err:e}),e}))}function formatData(e){if(e&&e.length)return 1===e.length?e[0]:e}function moduleMethodWrapper({importModule:e,methodName:t,method:n}){return"on"===t?(o,i)=>n((n=>{write({type:e,event:t,data:o,result:n}),i(n)})):(...o)=>n(...o).then((n=>{const i=formatData(o);return write({type:e,event:t,data:i,result:n}),n}))}function moduleMethodUnwrapper({importModule:e,methodName:t}){return"on"===t?(n,o)=>{subscribeEvent({type:e,event:t,cb:o})}:async(...n)=>{const o=formatData(n);return moduleUnwrapper({module:await read({type:e,event:t,data:o}),event:t})}}function injectMockDateValues(e){const t=864e5,n={d:t,w:6048e5,m:2592e6};try{const[t,o,i,a]=e.match(/([-|\+])(\d+)([d|w|m]$)/),r=Number(i)*n[a];return"+"===o?Date.now()+r:Date.now()-r}catch(t){return console.log(`Something went wrong injecting static value for ${e}`,t),e}}function moduleUnwrapper({module:e,event:t}){for(const n in e){const o=e[n];"object"!=typeof o||Array.isArray(o)||(e[n]=moduleUnwrapper({module:o,event:n})),o?.includes?.("now")&&(e[n]=injectMockDateValues(o)),"function"===o&&(e[n]=moduleMethodUnwrapper({importModule:t,methodName:n}))}return e}function promisify(e){return(...t)=>new Promise(((n,o)=>e(...t).then(n,o)))}const native={imageSource:({type:e,dataId:t})=>`coui://${e}/${t}`,call(e,...t){const n=window.native.call(e,...t);return n&&n.then?new Promise(((o,i)=>{n.then((n=>{window.native.record&&write({type:"call",event:e,data:t,result:n}),o(n)}),(n=>{window.native.record&&write({type:"call",event:e,data:t,err:n}),i(n)}))})):(n&&window.native.record&&write({type:"call",event:e,data:t,result:n}),Promise.resolve(n))},import:e=>new Promise((t=>{window.native.import(e,(n=>{const o=Object.setPrototypeOf({},Object.getPrototypeOf(n)),i={};o.on=o.on.bind(n);for(const t in n){if(!n.hasOwnProperty(t)&&"on"!==t)continue;const a=n[t];"function"==typeof a?("on"!==t&&(o[t]=promisify(a.bind(n))),window.native.record&&(o[t]=moduleMethodWrapper({importModule:e,methodName:t,method:a}),i[t]="function")):(o[t]=a,i[t]=a)}window.native.record&&write({type:"import",event:e,result:i}),t(o)}))})),on(e,t){window.native.on(e,(n=>{window.native.record&&write({type:"on",event:e,result:n}),t(n)}))}},imageSourceMap=new Map,nativeMock={imageSource({type:e,dataId:t}){const n=["404","aloha","attack","bear","bowl","box","breakfast","bubble","cake","cheer","coffee","construction","cow","cry","elf","ghost","girl","hat","helmut","hoodie-down","hoodie-up","killerwhale","knight","lollipop","lost","moving","party","present","quaggan","rain","scifi","seahawks","sleep","summer","vacation"],o=`${e}-${t}`;let i=imageSourceMap.get(o);return void 0===i&&(i=Math.floor(Math.random()*(n.length-1)),imageSourceMap.set(o,i)),`https://static.staticwars.com/quaggans/${n[i]}.jpg`},call:(e,t)=>read({type:"call",event:e,data:t}),import:async e=>moduleUnwrapper({module:await read({type:"import",event:e}),event:e}),on(e,t){subscribeEvent({type:"on",event:e,cb:t})}},isMockEnv=!("native"in window),game=isMockEnv?nativeMock:native;game.initSession=initSession.bind(null,isMockEnv),game.initNative=initNative.bind(null,game,isMockEnv);export{game};